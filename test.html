<!DOCTYPE html>
<html>
    <head>
        <title>Test</title>
        <link rel="preload" href="./assets/digitaldream.ttf" as="font" type="font/ttf" crossorigin />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./css/reset.css" />
        <link rel="stylesheet" href="./css/clock.css" />
        <link rel="stylesheet" href="./css/styles.css" />
        <script src="./js/consts.js"></script>
    </head>

    <body>
        <div id="clock-test" style="display: flex; align-items: center; justify-content: center; padding: 2rem 0"></div>

        <script type="module">
            import { $, getCssProperty } from "./js/utils.mjs";
            import { rad2Deg, normalize, vAngleBetween } from "./js/math.mjs";
            import { instantiateClock } from "./js/core.mjs";

            const c = instantiateClock(undefined, undefined, { className: "game-clock" });
            $("#clock-test").append(c);

            const hoursPointer = $(".pointer.hours");

            hoursPointer.addEventListener("mousedown", () => {
                c.dataset.setting = "hours";
            });

            document.addEventListener("mouseup", () => {
                if (c.dataset.setting) {
                    delete c.dataset.setting;
                }
            });

            const getHours = getCssProperty("hour");

            const center = (() => {
                const { x, y, width, height } = c.getBoundingClientRect();
                return {
                    x: x + width / 2,
                    y: y + height / 2,
                };
            })();

            // const origin = $("#origin-point");
            // origin.style.top = center.y + "px";
            // origin.style.left = center.x + "px";
            // origin.dataset.set = true;

            // const rectel = $("#rect");

            // Mam obecny kąt, Mam punkt środkowy, mam punkt w którym znajduje się myszka.
            // To chyba wszystko czego potzebuję. Chcę wyliczyć kąt między prostą przechodzącą
            // przez C (center) i przez M (myszka), a prostą idącą wzdłuż wektora UP i porównać ten kąt
            // z kątem obecnym.

            window.addEventListener("mousemove", (event) => {
                if (!c.dataset.setting) return;

                // const pointerPoints = (() => {
                //     // const rect = hoursPointer.getBoundingClientRect();
                //     // rectel.style.left = rect.x + "px";
                //     // rectel.style.top = rect.y + "px";
                //     // const width = rect.right - rect.x;
                //     // rectel.style.width = width + "px";
                //     // rectel.style.height = rect.bottom - rect.y + "px";

                //     // Create a vector from center at the currentAngle angle and make the origin a
                //     // point along that vector at hours pointer length from the center.

                //     return {
                //         origin: {
                //             x: rect.right - width / 2,
                //             y: rect.bottom,
                //         },
                //         end: {
                //             x: rect.x + width / 2,
                //             y: rect.y,
                //         },
                //     };
                // })();

                // const originPoint = pointerPoints.origin;
                // if (!origin.dataset.set) {
                //     origin.style.top = originPoint.y + "px";
                //     origin.style.left = originPoint.x + "px";
                //     origin.dataset.set = true;
                // }

                const M = event;
                const C = center;
                const U = { x: center.x, y: center.y - 10 };
                const vCM = { x: M.x - C.x, y: M.y - C.y };
                const vCU = { x: U.x - C.x, y: U.y - C.y };
                const scalar = vCM.x * vCU.x + vCM.y * vCU.y;
                const lenCM = Math.sqrt(vCM.x ** 2 + vCM.y ** 2);
                const lenCU = Math.sqrt(vCU.x ** 2 + vCU.y ** 2);
                let angle = (Math.acos(scalar / (lenCM * lenCU)) * 180) / Math.PI;
                // poprawianie kąta tak, żeby zawsze był od 0 do 360, bo normalnie w js jest do max 180 i nie
                // ma kąta ujemnego, więc nie miałem rozróżnienia po której stronie okręgu znajduje się kursor.
                if (M.x < C.x) angle = Math.abs(angle - 360);

                const currentHours = getHours(c);
                const currentAngle = currentHours * DEGREES_IN_HOUR;
                console.log(angle, currentAngle);

                c.style.setProperty(
                    "--hour",
                    angle > currentAngle ? Math.floor(angle / DEGREES_IN_HOUR) : Math.ceil(angle / DEGREES_IN_HOUR)
                );
            });
        </script>
        <div
            id="origin-point"
            style="width: 4px; height: 4px; background: red; position: absolute; top: 0; left: 0"
        ></div>
        <div id="rect" style="border: 1px solid red; position: absolute; top: 0; left: 0"></div>
    </body>

    <template id="t-clock">
        <div class="outer-circle" style="--hour: 8; --minutes: 15">
            <div class="minutes pointer"></div>
            <div class="hours pointer"></div>
            <div class="seconds pointer"></div>
        </div>
    </template>
</html>
